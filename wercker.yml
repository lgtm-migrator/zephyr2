#
# This is the configuration file for a Wercker build.
# Wercker is a continuous integration platform similar to Travis
#
# http://wercker.com
box: zuzak/nodebox
build:
    steps:
        - script:
            name: install dependencies
            code: |
                npm install

        - script:
            name: run application and test
            code: |
                npm start &
                npm test

        - script:
            name: instrument code
            code: |
                jscoverage app app-cov

        - script:
            name: generate pages
            code:
                export USE_COVERAGE=1
                ./node_modules/.bin/mocha test -R htmlcov 
                git add coverage.html
                git commit -m "update coverage for $WERCKER_BUILD_URL"
                git config user.email "pleaseemailus@wercker.com"
                git config user.name "werckerbot"
                git push -f "https://$WERCKER_PAGES_TOKEN@github.com:$WERCKER_GIT_OWNER/$WERCKER_GIT_REPOSITORY.git" gh-pages
        - script:
            name: send coverage to coveralls
            code: |
                export COVERALLS_SERVICE_NAME=wercker
                export COVERALLS_SERVICE_JOB_ID=$WERCKER_BUILD_ID
                export COVERALLS_RUN_AT=$WERCKER_MAIN_PIPELINE_STARTED
                export COVERALLS_GIT_COMMIT=$WERCKER_GIT_COMMIT
                export USE_COVERAGE=1
                ./node_modules/.bin/mocha test -R mocha-lcov-reporter | ./node_modules/coveralls/bin/coveralls.js
